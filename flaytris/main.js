const s=x('game').getContext('2d');const t=document.createElement('canvas');const e=t.getContext('2d');const i=1e3/60;let n=0;let o=0;let a=[];let c={};let h={};let l=[];let f=false;let r=0;let u=0;let M=0;let y=0;const d={left:false,right:false,t:false};const m=[[0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,0],[0,1,0,0,0,0,1,0],[0,1,0,1,0,0,1,0],[0,1,0,2,1,0,1,0],[0,1,1,0,0,0,1,0],[0,2,1,1,1,1,1,0],[1,0,0,0,0,0,0,0]];const w=[[[0,0,0,1,1,0,1,1],[0,0,0,1,1,0,1,1],[0,0,0,1,1,0,1,1],[0,0,0,1,1,0,1,1]],[[0,0,0,1,1,0,0,2],[0,0,1,0,2,0,2,1],[0,2,1,2,1,1,1,0],[0,0,0,1,1,1,2,1]],[[0,0,1,0,1,1,2,1],[0,1,0,2,1,1,1,0],[0,0,1,0,1,1,2,1],[0,1,0,2,1,1,1,0]],[[0,0,1,0,2,0,1,1],[0,1,1,0,1,1,1,2],[1,0,0,1,1,1,2,1],[0,0,0,1,0,2,1,1]],[[0,0,1,0,2,0,3,0],[0,0,0,1,0,2,0,3],[0,0,1,0,2,0,3,0],[0,0,0,1,0,2,0,3]]];const p=[[1,1,1,1],[1,2,1,2],[2,1,2,1],[2,1,2,1],[3,0,3,0]];const A=[[1,1,1,1],[2,1,2,1],[1,2,1,2],[1,2,1,2],[0,3,0,3]];class g{constructor(){this.x=0;this.y=0;this.i=0;this.o=0;this.l=0;this.h=null;this.u=null;this.grid=[];this.initialize();this.M()}initialize(){this.i=Math.floor(Math.random()*5);this.l=Math.floor(Math.random()*4);this.x=Math.floor(Math.random()*(80-(p[this.i][this.l]+1)*8+1));this.o=Math.floor(Math.random()*5);this.h=document.createElement('canvas');this.h.width=32;this.h.height=32;this.u=this.h.getContext('2d')}m(){this.grid=Array.from({length:32},()=>Array(32).fill(null))}M(){this.m();D(this.grid,0,31,w[this.i][this.l],this.o);$(this.grid,this.u,32,32)}p(){s.drawImage(this.h,this.x*4,(this.y-32)*4,128,128)}update(){if(d.left){this.x-=1;if(this.x<0)this.x=0}if(d.right){this.x+=1;let t=p[this.i][this.l]+1;if(this.x>80-t*8)this.x=80-t*8}if(d.t)this.y+=1.2;const e=Math.floor(this.x);const s=Math.floor(this.y);let i=false;if(s>158){i=true}else{for(let t=0;t<4;t++){const n=t*2;const o=w[this.i][this.l][n];const l=w[this.i][this.l][n+1];const f=Math.floor(e+o*8);const r=Math.floor(s-l*8);if(r<=0)continue;for(let t=0;t<8;t++){if(a[r+1][f+t]!==null){if(a[r][f+t])this.y-=1;i=true}}}}if(i){if(this.y-8*(A[this.i][this.l]+1)<0)v();D(a,e,Math.min(s,159),w[this.i][this.l],this.o);c=h;h=new g;if(c.o===h.o){if(Math.random()<.5){h.o=(h.o+1)%4;h.M()}}q(true,false)}else{this.y+=.8}}rotate(){this.l=(this.l+1)%4;this.x=Math.min(80-(p[this.i][this.l]+1)*8,this.x);this.M()}}function k(){y=2;M=0;u=0;f=false;l=[];r=0;o=0;n=0;a=Array.from({length:160},()=>Array(80).fill(null));c=new g;h=new g;q(true,true);requestAnimationFrame(S);I('start pause gameover',false)}function b(){if(y===1){y=2;requestAnimationFrame(S);I('pause',false)}else if(y===2){y=1;I('pause',true)}else{k()}}function v(){y=0;let t;try{t=localStorage.getItem('flayData')}catch{}if(t){t=t.split(" ")}else{t=["0","0"]}let e=parseInt(t[0]);let s=parseInt(t[1]);if(M>e){e=M;s=u;try{localStorage.setItem('flayData',e+" "+s)}catch{}}const[i,n]=L(true);let o="";if(i>0)o+=E(i,"minute");if(n>0){if(o.length>0)o+=" and ";o+=E(n,"second")}x('time').textContent=`You survived for ${o}`;x('result').textContent=`${E(M,"point")} • ${E(u,"layer")}`;x('best').textContent=`${E(e,"point")} • ${E(s,"layer")}`;I('gameover',true)}function D(s,i,n,e,o){const l=[];const f=z(o,0,4,0,.69);for(let t=0;t<3;t++)l.push(j(f,.71,z(t,0,2,.55,1)));for(let t=0;t<4;t++){const r=e[t*2]*8;const a=e[t*2+1]*8;for(let e=0;e<8;e++){for(let t=0;t<8;t++){const c=i+r+t;const h=n-a-e;if(h<0)continue;const u=l[m[e][t]];s[h][c]=[o,u[0],u[1],u[2],0]}}}}function F(t,e){if(a[e][t]===null)return;a[e][t][4]=0;if(e>=159)return;if(a[e+1][t]===null){a[e+1][t]=a[e][t];a[e][t]=null}else{const s=t>0&&a[e+1][t-1]===null;const i=t<79&&a[e+1][t+1]===null;if(s&&i){if(Math.random()<.5){a[e+1][t-1]=a[e][t];a[e][t]=null}else{a[e+1][t+1]=a[e][t];a[e][t]=null}}else if(s){a[e+1][t-1]=a[e][t];a[e][t]=null}else if(i){a[e+1][t+1]=a[e][t];a[e][t]=null}}}function R(){if(o%4===0){for(let e=159;e>=0;e--){for(let t=0;t<80;t++)F(t,e)}}else if(o%4===2){for(let e=159;e>=0;e--){for(let t=79;t>=0;t--)F(t,e)}}}function U(){for(let t=0;t<160;t++){l=[];f=false;if(a[t][0]===null||a[t][0][4]===1)continue;K(0,t,a[t][0][0]);if(f)return}}function K(t,e,s){if(t<0||t>=80||e<0||e>=160||a[e][t]===null||a[e][t][4]===1||a[e][t][0]!==s)return;if(t===79)f=true;a[e][t][4]=1;l.push([t,e]);K(t+1,e,s);K(t-1,e,s);K(t,e+1,s);K(t,e-1,s)}function $(s,t,i,n){const e=t.createImageData(i,n);const o=e.data;for(let e=0;e<n;e++){for(let t=0;t<i;t++){const l=(e*i+t)*4;const f=s[e][t];if(f!==null){o[l]=f[1];o[l+1]=f[2];o[l+2]=f[3];o[l+3]=255}}}t.putImageData(e,0,0)}function W(){s.fillStyle='#15151D';s.fillRect(0,0,320,640);$(a,e,80,160);s.drawImage(t,0,0,320,640);c.p();if(o%60===0)q(false,true)}function q(t,e){if(t){s.fillStyle='#15151D';s.fillRect(350,0,160,160);s.drawImage(h.h,350+(5-(p[h.i][h.l]+1))*16,A[h.i][h.l]+15,128,128)}if(e){s.clearRect(350,180,250,160);s.fillStyle='#F1F1F1';s.fillText(E(M,"point"),360,220);s.fillText(E(u,"layer"),360,270);s.fillText(L(false),360,320)}}function Y(){if(f){const t=z(r,30,0,25,255);for(const e of l){a[e[1]][e[0]][1]=t;a[e[1]][e[0]][2]=t;a[e[1]][e[0]][3]=t}r++;if(r>30){for(const e of l)a[e[1]][e[0]]=null;M+=l.length;u++;r=0;f=false;q(false,true)}return}c.update();R();U()}function S(t){if(y===2)requestAnimationFrame(S);const e=t-n;if(e>=i-.1){n=t-e%i;o++;Y();W()}}function I(t,e){const s=[...t.split(' '),'game','overlay'];for(const i of s)x(i).classList.toggle('open',e)}function x(t){return document.getElementById(t)}function z(t,e,s,i,n){return i+(n-i)*((t-e)/(s-e))}function j(t,e,s){const i=Math.floor(t*6);const n=t*6-i;const o=s*(1-e);const l=s*(1-n*e);const f=s*(1-(1-n)*e);let r,a,c;switch(i%6){case 0:r=s;a=f;c=o;break;case 1:r=l;a=s;c=o;break;case 2:r=o;a=s;c=f;break;case 3:r=o;a=l;c=s;break;case 4:r=f;a=o;c=s;break;case 5:r=s;a=o;c=l;break}return[Math.round(r*255),Math.round(a*255),Math.round(c*255)]}function E(t,e){const s=t.toString();let i="";let n=0;for(let t=s.length-1;t>=0;t--){i=s[t]+i;n++;if(n%3===0&&t!==0)i=" "+i}if(t!==1)e+="s";return i+" "+e}function L(t){let e=Math.floor(o/3600);let s=Math.floor(o/60)%60;if(t)return[e,s];if(e<10)e="0"+e;if(s<10)s="0"+s;return e+":"+s}function P(t){const e=t.code;const s=t.type==='keydown';if(e.startsWith('Arrow'))t.preventDefault();if(t.repeat)return;if(['KeyS','ArrowDown'].includes(e)){d.t=s}else if(['KeyA','ArrowLeft'].includes(e)){d.left=s}else if(['KeyD','ArrowRight'].includes(e)){d.right=s}else if(['KeyW','ArrowUp'].includes(e)&&s){c.rotate()}else if(['KeyP','Escape'].includes(e)&&s){b()}}document.addEventListener('keydown',P);document.addEventListener('keyup',P);document.addEventListener('click',t=>{const e=t.target.name;if(e==='start'){k()}else if(e==='pause'){b()}});window.addEventListener('load',()=>{t.width=80;t.height=160;s.font='30px sans-serif';s.imageSmoothingEnabled=false});